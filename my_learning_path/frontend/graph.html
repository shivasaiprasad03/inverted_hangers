<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Learning Path Graph</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <style>
        #mynetwork { width: 100%; height: 520px; border: 1px solid #d1d5db; border-radius: 8px; background: #f9fafb; margin-top: 1em; }
        .graph-controls { margin: 1em 0; display: flex; gap: 1em; flex-wrap: wrap; }
        .legend { margin-top: 1em; font-size: 0.98em; color: #475569; }
        .legend span { display: inline-block; width: 18px; height: 18px; border-radius: 4px; margin-right: 0.5em; vertical-align: middle; }
        .legend .learned { background: #059669; }
        .legend .current { background: #f59e42; }
        .legend .default { background: #2563eb; }
    </style>
</head>
<body>
<div class="container">
    <h1>Learning Path Graph</h1>
    <div class="graph-controls">
        <button onclick="loadGraph()">Load Topics Graph</button>
        <button onclick="resetProgress()">Reset Progress</button>
        <button onclick="exportProgress()">Export Progress</button>
        <input type="file" id="importFile" style="display:none" onchange="importProgress(event)">
        <button onclick="document.getElementById('importFile').click()">Import Progress</button>
        <button onclick="toggleDarkMode()" id="darkModeBtn">üåô Dark Mode</button>
    </div>
    <div id="mynetwork"></div>
    <div id="nodeInfo" class="result"></div>
    <div id="resourcePreview" class="result" style="display:none;"></div>
    <div class="legend">
        <b>Legend:</b>
        <span class="learned"></span> Learned
        <span class="current"></span> Current
        <span class="default"></span> Not learned
    </div>
    <a href="index.html">Back to Main</a>
</div>
<script>
let learnerState = {};
let currentNode = null;
let network = null;
let topics = [];
let edges = [];

async function loadGraph() {
    // Fetch topics and dummy edges from backend
    const res = await fetch('http://127.0.0.1:8000/build_graph', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ urls: ["dummy"] })
    });
    const data = await res.json();
    topics = data.nodes || [];
    // Dummy edges: connect each topic to the next
    edges = [];
    for (let i = 0; i < topics.length - 1; i++) {
        edges.push({ from: topics[i], to: topics[i+1] });
    }
    // Build vis.js graph
    const nodes = topics.map(t => ({ id: t, label: t, color: getNodeColor(t) }));
    const container = document.getElementById('mynetwork');
    const networkData = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
    const options = {
        nodes: { shape: 'box', font: { color: '#fff', size: 18 } },
        edges: { arrows: 'to', color: '#94a3b8' },
        layout: { hierarchical: { direction: 'LR', sortMethod: 'directed' } },
        physics: false,
        manipulation: {
            enabled: true,
            addNode: false,
            addEdge: function (data, callback) {
                if (data.from !== data.to) {
                    edges.push({ from: data.from, to: data.to });
                    callback(data);
                }
            },
            deleteNode: false,
            deleteEdge: false,
            editNode: false,
            editEdge: false
        }
    };
    network = new vis.Network(container, networkData, options);
    network.on('selectNode', function(params) {
        const nodeId = params.nodes[0];
        currentNode = nodeId;
        showNodeInfo(nodeId);
        highlightNode(network, nodeId);
        showResourcePreview(nodeId);
    });
    network.on('dragEnd', function(params) {
        // Simulate real-time update (could be sent to server)
        // For hackathon: just reload graph to reflect changes
        setTimeout(() => highlightNode(network, currentNode), 100);
    });
}

function getNodeColor(topic) {
    if (learnerState[topic] === 1.0) return '#059669'; // learned
    if (topic === currentNode) return '#f59e42'; // current
    return '#2563eb'; // default
}

function showNodeInfo(nodeId) {
    let html = `<b>Topic:</b> ${nodeId}`;
    if (learnerState[nodeId] === 1.0) {
        html += ' <span class="success">(Learned)</span>';
    } else {
        html += `<br><button onclick=\"markLearned('${nodeId}')\">Mark as Learned</button>`;
    }
    document.getElementById('nodeInfo').innerHTML = html;
}

async function markLearned(topic) {
    const res = await fetch('http://127.0.0.1:8000/update_learner', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ concept_id: topic, mastery: 1.0 })
    });
    const data = await res.json();
    learnerState = data.knowledge_state || {};
    loadGraph();
    document.getElementById('nodeInfo').innerHTML = `<b>Topic:</b> ${topic} <span class="success">(Learned)</span>`;
}

function highlightNode(network, nodeId) {
    // Visually highlight the selected node
    let update = [];
    network.body.data.nodes.forEach(function(node) {
        update.push({ id: node.id, color: getNodeColor(node.id) });
    });
    network.body.data.nodes.update(update);
}

function resetProgress() {
    learnerState = {};
    loadGraph();
    document.getElementById('nodeInfo').innerHTML = '';
    document.getElementById('resourcePreview').style.display = 'none';
}

function exportProgress() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(learnerState));
    const dlAnchor = document.createElement('a');
    dlAnchor.setAttribute("href", dataStr);
    dlAnchor.setAttribute("download", "progress.json");
    document.body.appendChild(dlAnchor);
    dlAnchor.click();
    dlAnchor.remove();
}

function importProgress(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            learnerState = JSON.parse(e.target.result);
            loadGraph();
        } catch (err) {
            alert('Invalid file!');
        }
    };
    reader.readAsText(file);
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const btn = document.getElementById('darkModeBtn');
    btn.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
}

function showResourcePreview(nodeId) {
    // Simulate a resource preview (could fetch summary/thumbnail from backend)
    const previewDiv = document.getElementById('resourcePreview');
    previewDiv.innerHTML = `<b>Resource Preview for:</b> ${nodeId}<br><img src='https://source.unsplash.com/100x60/?education,${encodeURIComponent(nodeId)}' style='border-radius:4px;margin:0.5em 0;'>`;
    previewDiv.style.display = '';
}
</script>
</body>
</html>
